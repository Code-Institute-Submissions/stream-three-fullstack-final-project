{% extends 'base.html' %}
{% load static %}
{% block head_js %}
<script defer type="text/javascript" src="{% static '/js/utility.js' %}"></script>
<script defer type="text/javascript" src="{% static '/js/head.js' %}"></script>
<script defer type="text/javascript" src="{% static '/js/porthole.js' %}"></script>
{% endblock head_js %}
{% block content %}
{% include 'header.html' %}
<div class="porthole-container">
        <div class="porthole-icon">
            <i class="fas fa-circle porthole-icon__icon" aria-hidden="true"></i>
        </div>
        <h1 class="porthole-heading">Cycle Porthole</h1>
    <!--- CYCLE PORTHOLE DETAILS -->
    <section class="porthole-details">
        <div class="porthole-details__row">
            <div class="porthole-details__column">
                <p class="porthole-details__text"><strong>Fileo Cycle ID: </strong> {{ context.cycle.id }}</p>
            </div>
            <div class="porthole-details__column">
                {% if context.cycle_status.cancelled %}
                    <p class="porthole-details__text"><i data-id="cancelled" class="fas fa-ban" aria-hidden="true"></i> Cancelled</p>
                {% elif context.cycle_status.pending %}
                    <p class="porthole-details__text"><i data-id="pending" class="far fa-clock" aria-hidden="true"></i> Payment Pending</p>
                {% elif context.cycle_status.complete %}
                    <p class="porthole-details__text"><i data-id="complete" class="fas fa-check-circle" aria-hidden="true"></i> Complete</p>
                {% else %}
                    <p class="porthole-details__text"><i data-id="active" class="fas fa-walking" aria-hidden="true"></i> Active</p>
                {% endif %}
            </div>
        </div> 
        <hr class="porthole-details-hr">
        <div class="porthole-details__row">
            <div class="porthole-details__column">
                <p class="porthole-details__text"><i class="fas fa-user" aria-hidden="true"></i> {{ context.cycle.client.first_name }} {{ context.cycle.client.last_name }}</p>
            </div>
        </div>
        <hr class="porthole-details-hr">
        <div class="porthole-details__row">
            <div class="porthole-details__column">
                <p class="porthole-details__text"><i class="fas fa-briefcase manage-item__icon" aria-hidden="true"></i> {{ context.cycle.job.job_title }}</p>
                <p class="porthole-details__text"><i class="fas fa-hashtag manage-item__icon" aria-hidden="true"></i> {{ context.cycle.job.job_number }}</p>
            </div>
        </div>
        <hr class="porthole-details-hr">
        <div class="porthole-details__row">
            <div class="porthole-details__column">
                <p class="porthole-details__text"><i class="far fa-circle" aria-hidden="true"></i> {{ context.cycle.cycle_title }}</p>
                <p class="porthole-details__text"><i class="fas fa-map-marked-alt" aria-hidden="true"></i> {{ context.cycle.location }}</p>
            </div>  
        </div>
        <hr class="porthole-details-hr">
        <div class="porthole-details__row">
            <div class="porthole-details__column">
                <p class="porthole-details__text">{{ context.cycle.description }}</p>
            </div>
        </div>
        <hr class="porthole-details-hr">
        <div class="porthole-details__row">
            <div class="porthole-details__column">
                <p class="porthole-details__text"><i class="far fa-calendar" aria-hidden="true"></i> From: {{ context.cycle_start }}</p>
            </div>
            <div class="porthole-details__column">
                <p class="porthole-details__text"><i class="far fa-calendar" aria-hidden="true"></i>  To: {{ context.cycle_end }}</p>
            </div>
        </div>
        <hr class="porthole-details-hr">
        <div class="porthole-details__row">
            <div class="porthole-details__column">
                {% if context.cycle.cycle_value %}
                <p class="porthole-details__text"><i class="fas fa-pound-sign" aria-hidden="true" ></i> {{ context.cycle.cycle_value }}</p>
                {% else %}
                <p class="porthole-details__text"><i class="fas fa-pound-sign" aria-hidden="true"></i> Cycle Value not entered yet.</p>
                {% endif %}
            </div>
        </div>
    </section>
    <hr class="porthole-details-hr">
    <!------ QUOTE UPLOAD FOR MEMBER ONLY -->
    {% include 'quote.html' %}
    <hr>
    <!-------- VIEWABLE BY CLIENT ONLY -------------->
    <div>
        <h3>Upload Your PO</h3>
        <img alt='Show image of PDF icon if uploaded'>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{ po_form.as_p }}
            <!--<input type="hidden" name="file_type" value="po">-->
            <div class=browse-button>
                <input class="browse-button__button" type="button" value="Browse..."/>
            </div>
            <button type="submit">Submit</button>
        </form>
        {% if context.po %}
            <form action="{% url 'delete' username=context.member.username cycle_id=context.cycle.id step='po' %}">
                <button type="submit">Delete PO</button>
            </form>
            <form action="{% url 'step_notify' username=context.member.username cycle_id=context.cycle.id step='po' %}">
                <button type="submit">Notify Member</button>
            </form>
        {% endif %}
        {% for message in messages %}
        {% if 'po_delete' in message.tags %}
            <p>{{message}}</p>
        {% endif %}
        {% endfor %}
        <!------ VIEWABLE BY MEMBER AND CLIENT -------------->
        <p>File uploaded at: {{ context.po.uploaded_at }}</p>
        <ul>
            <li><a href="{{ context.po.file.url }}" download>Download File</a></li>
            <li><a href="{{ context.po.file.url }}" target="_blank">View in Browser</a></li> 
        </ul>
         <!------ VIEWABLE BY MEMBER AND CLIENT -------------->
        <div>
            <h4>PO Status</h4>
            <h4>Approval</h4>
            {% if context.cycle_status.approve_po %}
                <p>Status: Approved</p>
            {% elif context.cycle_status.contest_po %}
                <p>Status: Contested</p>
            {% else %}
                <p>No Status</p>
            {% endif %}
            <div>
        <!---------- VIEWABLE BY MEMBER ONLY -------------------->
                {% for message in messages %}
                    {% if 'po_message' in message.tags %}
                        {{message}}
                    {% endif %}
                {% endfor %}
                <form action="{% url 'po_status' username=context.member.username cycle_id=context.cycle.id %}" method="POST">
                    <fieldset>
                        {% csrf_token %}
                        {{ context.status_form.as_p }}
                        <button type="submit">Set Status</button>
                    </fieldset>
                </form>
            </div>
        </div>
    </section>
    <hr>
    <!--------VIEWABLE BY MEMBER ONLY ------------------>
    <div>
        <h3>Upload Your Invoice</h3>
        <img alt='Show image of PDF icon if uploaded'>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{ invoice_form.as_p }}
            <!--<input type="hidden" name="file_type" value="invoice">-->
            <div class=browse-button>
                <input class="browse-button__button" type="button" value="Browse..."/>
            </div>
            <button type="submit">Upload</button>
        </form>
        {% if context.invoice %}
        <form action="{% url 'delete' username=context.member.username cycle_id=context.cycle.id step='invoice' %}">
            <button type="submit">Delete Invoice</button>
        </form>
        <form action="{% url 'step_notify' username=context.member.username cycle_id=context.cycle.id step='invoice' %}">
            <button type="submit">Notify Client</button>
        </form>
        {% endif %}
        {% for message in messages %}
        {% if 'invoice_delete' in message.tags %}
            <p>{{message}}</p>
        {% endif %}
        {% endfor %}
        <!-------- VIEWABLE BY BOTH MEMBER AND CLIENT -------------->
        <p>File uploaded at: {{ context.invoice.uploaded_at }}</p>
        <ul>
            <li><a href="{{ context.invoice.file.url }}" download>Download File</a></li>
            <li><a href="{{ context.invoice.file.url }}" target="_blank">View in Browser</a></li> 
        </ul>
        <!-------- VIEWABLE BY BOTH MEMBER AND CLIENT -------------->
        <div>
            <h4>Invoice Status</h4>
            {% if context.cycle_status.approve_invoice %}
                <p>Status: Approved</p>
            {% elif context.cycle_status.contest_invoice %}
                <p>Status: Contested</p>
            {% else %}
                <p>No Status</p>
            {% endif %}
        <!-------- VIEWABLE BY CLIENT ONLY -------------------------->
            <div>
                {% for message in messages %}
                    {% if 'invoice_message' in message.tags %}
                            {{message}}
                    {% endif %}
                {% endfor %}
                <form action="{% url 'invoice_status' username=context.member.username cycle_id=context.cycle.id %}" method="POST">
                    <fieldset>
                        {% csrf_token %}
                        {{ context.status_form.as_p }}
                        <button type="submit">Set Status</button>
                    </fieldset>
                </form>
            </div>
            <br>
            {% if request.user.is_client %}
                {% if context.cycle_status.pending %}
                <div>
                    <form action="{% url 'payment' username=user.username cycle_id=context.cycle.id %}">
                        <button>Payment</button>
                    </form>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </section>
    <hr>
</div>
{% endblock %}